# 视频直播原理

## 流程

直播数据的整个流程大概是这样的：

- 首先，我们需要直播源，也就是我们平常看到的摄像头等视频采集工具。
- 然后，将采集的视频数据进行压缩编码，进行推流
- 推流到 CDN 之后，用户终端访问，进行播放

所以说，从上面我们就能够看出一些问题，为什么一些主播需要高清的摄像头，因为这能够保证直播源的高质量，保证数据到达用户的客户端时还能够保持相当高的清晰度。

## 视频格式

- mp4: 兼容性好，偏点播
- webm：流式的视频格式，safari 不支持，偏点播
- hls(.ts)：Safari 支持，其他的不支持，偏直播
- flv：(B 站使用这样的格式)h5 播放器，偏直播

## 直播协议

- __HLS协议：__ 苹果推出的直播协议，video 获取 m3u8 文件，这是一个索引文件，索引了多个 .ts 文件片段，直播就是更新 m3u8 文件(纯文本文件)，播放器会在片段播放完之前请求更新 m3u8 文件。m3u8 文件里不一定是包含的 ts 文件，有可能还嵌套着 m3u8 文件。

  - 动态列表：直播用
  - 静态列表：静态列表几乎没人用
  - 全量列表：点播用，文件不变化

  ts 文件如何区别视频和音频，PAT(告知如何找到 PMT) -> PMT(标识下面的 ts 文件是视频还是音频) -> PES(TS 文件包)。

  实时性相对来说，差一点。延时要求不高就可以使用 hls。

- __RTMP 协议(Real Time Messaging Protocol)：__ 实时消息传输协议，该协议是基于 TCP 的。主要用在客户端，使用复杂，处理应答等等，但实时性好，采集使用。

- __Http-FLV协议：__ 建立长链接。可以使用 https 加密，很好的支持移动端。很好的兼容 302 （CDN）。