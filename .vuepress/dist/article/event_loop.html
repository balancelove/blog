<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一道面试题引发的血案 | 小烜同学</title>
    <meta name="description" content="天衣无缝的秘密是: 做技术，你快乐吗？">
    <link rel="icon" href="/img/logo.ico">
  <link rel="manifest" href="/manifest.json">
    
    <link rel="preload" href="/assets/css/0.styles.4744510a.css" as="style"><link rel="preload" href="/assets/js/app.957eca14.js" as="script"><link rel="preload" href="/assets/js/2.ca8fc919.js" as="script"><link rel="preload" href="/assets/js/17.bccf36a0.js" as="script"><link rel="prefetch" href="/assets/js/10.e3c857f3.js"><link rel="prefetch" href="/assets/js/100.3a40c1ed.js"><link rel="prefetch" href="/assets/js/101.5ed4e69c.js"><link rel="prefetch" href="/assets/js/102.154667c9.js"><link rel="prefetch" href="/assets/js/103.f9340747.js"><link rel="prefetch" href="/assets/js/104.c2856033.js"><link rel="prefetch" href="/assets/js/105.7378dce0.js"><link rel="prefetch" href="/assets/js/106.58e332fb.js"><link rel="prefetch" href="/assets/js/107.da90283f.js"><link rel="prefetch" href="/assets/js/108.3bcd25d1.js"><link rel="prefetch" href="/assets/js/109.1f6f6ad4.js"><link rel="prefetch" href="/assets/js/11.2cf393e7.js"><link rel="prefetch" href="/assets/js/110.b7128856.js"><link rel="prefetch" href="/assets/js/111.0a1fcae3.js"><link rel="prefetch" href="/assets/js/112.274fa231.js"><link rel="prefetch" href="/assets/js/113.791f66a9.js"><link rel="prefetch" href="/assets/js/114.afc0a216.js"><link rel="prefetch" href="/assets/js/115.48e964f8.js"><link rel="prefetch" href="/assets/js/116.bcf0e758.js"><link rel="prefetch" href="/assets/js/117.720b3629.js"><link rel="prefetch" href="/assets/js/118.3319e38a.js"><link rel="prefetch" href="/assets/js/119.4511d5f0.js"><link rel="prefetch" href="/assets/js/12.dc2cec8b.js"><link rel="prefetch" href="/assets/js/120.e4f80c91.js"><link rel="prefetch" href="/assets/js/121.9cc2d732.js"><link rel="prefetch" href="/assets/js/122.d25d91af.js"><link rel="prefetch" href="/assets/js/123.8981cff0.js"><link rel="prefetch" href="/assets/js/124.df7ea693.js"><link rel="prefetch" href="/assets/js/125.f9864e3e.js"><link rel="prefetch" href="/assets/js/126.c4ac2e61.js"><link rel="prefetch" href="/assets/js/127.01bc1323.js"><link rel="prefetch" href="/assets/js/128.ce02f128.js"><link rel="prefetch" href="/assets/js/129.e185f6a5.js"><link rel="prefetch" href="/assets/js/13.d979c613.js"><link rel="prefetch" href="/assets/js/130.72a188bf.js"><link rel="prefetch" href="/assets/js/131.1f1b0ba3.js"><link rel="prefetch" href="/assets/js/132.6a74cb4d.js"><link rel="prefetch" href="/assets/js/133.6c5bd198.js"><link rel="prefetch" href="/assets/js/134.46436b07.js"><link rel="prefetch" href="/assets/js/135.f4c40799.js"><link rel="prefetch" href="/assets/js/136.8f8b0680.js"><link rel="prefetch" href="/assets/js/137.2e673c9d.js"><link rel="prefetch" href="/assets/js/138.d4ae4809.js"><link rel="prefetch" href="/assets/js/139.b7ba396b.js"><link rel="prefetch" href="/assets/js/14.f0a33826.js"><link rel="prefetch" href="/assets/js/140.f62ddcd8.js"><link rel="prefetch" href="/assets/js/141.581b045b.js"><link rel="prefetch" href="/assets/js/142.f7e40e15.js"><link rel="prefetch" href="/assets/js/143.d14ed808.js"><link rel="prefetch" href="/assets/js/15.c25c55e3.js"><link rel="prefetch" href="/assets/js/16.bf2a9f12.js"><link rel="prefetch" href="/assets/js/18.8b831449.js"><link rel="prefetch" href="/assets/js/19.3709c025.js"><link rel="prefetch" href="/assets/js/20.d3d46cfc.js"><link rel="prefetch" href="/assets/js/21.20b48377.js"><link rel="prefetch" href="/assets/js/22.aef2434a.js"><link rel="prefetch" href="/assets/js/23.06d82b9c.js"><link rel="prefetch" href="/assets/js/24.661cfcd9.js"><link rel="prefetch" href="/assets/js/25.ca565fb9.js"><link rel="prefetch" href="/assets/js/26.4416886b.js"><link rel="prefetch" href="/assets/js/27.19de9017.js"><link rel="prefetch" href="/assets/js/28.7e83bdd3.js"><link rel="prefetch" href="/assets/js/29.1028830c.js"><link rel="prefetch" href="/assets/js/3.260a3926.js"><link rel="prefetch" href="/assets/js/30.879c3493.js"><link rel="prefetch" href="/assets/js/31.b443d0bd.js"><link rel="prefetch" href="/assets/js/32.458f8a8b.js"><link rel="prefetch" href="/assets/js/33.8118acfd.js"><link rel="prefetch" href="/assets/js/34.99834e8c.js"><link rel="prefetch" href="/assets/js/35.611a5792.js"><link rel="prefetch" href="/assets/js/36.b49de0de.js"><link rel="prefetch" href="/assets/js/37.8dbf7259.js"><link rel="prefetch" href="/assets/js/38.c8c79330.js"><link rel="prefetch" href="/assets/js/39.658561db.js"><link rel="prefetch" href="/assets/js/4.dea4a770.js"><link rel="prefetch" href="/assets/js/40.0fb5d749.js"><link rel="prefetch" href="/assets/js/41.d41811c9.js"><link rel="prefetch" href="/assets/js/42.675a5b3f.js"><link rel="prefetch" href="/assets/js/43.94551f25.js"><link rel="prefetch" href="/assets/js/44.ac0364dd.js"><link rel="prefetch" href="/assets/js/45.912ab322.js"><link rel="prefetch" href="/assets/js/46.d58ab50b.js"><link rel="prefetch" href="/assets/js/47.be6d944b.js"><link rel="prefetch" href="/assets/js/48.8e779971.js"><link rel="prefetch" href="/assets/js/49.7b5ca79b.js"><link rel="prefetch" href="/assets/js/5.16b279ca.js"><link rel="prefetch" href="/assets/js/50.b59de62e.js"><link rel="prefetch" href="/assets/js/51.8b620895.js"><link rel="prefetch" href="/assets/js/52.4ea2cb89.js"><link rel="prefetch" href="/assets/js/53.ecea3f13.js"><link rel="prefetch" href="/assets/js/54.26967223.js"><link rel="prefetch" href="/assets/js/55.5371178f.js"><link rel="prefetch" href="/assets/js/56.4c5ad11d.js"><link rel="prefetch" href="/assets/js/57.8dc26592.js"><link rel="prefetch" href="/assets/js/58.688ad059.js"><link rel="prefetch" href="/assets/js/59.7cd179db.js"><link rel="prefetch" href="/assets/js/6.db1b5afb.js"><link rel="prefetch" href="/assets/js/60.943434a0.js"><link rel="prefetch" href="/assets/js/61.dfdfab9b.js"><link rel="prefetch" href="/assets/js/62.a485860d.js"><link rel="prefetch" href="/assets/js/63.91a4b2e4.js"><link rel="prefetch" href="/assets/js/64.6d5118ac.js"><link rel="prefetch" href="/assets/js/65.df02bbf5.js"><link rel="prefetch" href="/assets/js/66.c6bd641a.js"><link rel="prefetch" href="/assets/js/67.a48f577b.js"><link rel="prefetch" href="/assets/js/68.b3906d5f.js"><link rel="prefetch" href="/assets/js/69.a2942f8e.js"><link rel="prefetch" href="/assets/js/7.711a8af6.js"><link rel="prefetch" href="/assets/js/70.3dc00872.js"><link rel="prefetch" href="/assets/js/71.36a9ccdf.js"><link rel="prefetch" href="/assets/js/72.50d71902.js"><link rel="prefetch" href="/assets/js/73.3ef2c8d4.js"><link rel="prefetch" href="/assets/js/74.2a6629b7.js"><link rel="prefetch" href="/assets/js/75.42d37ee7.js"><link rel="prefetch" href="/assets/js/76.8eb4fb01.js"><link rel="prefetch" href="/assets/js/77.b0c6a64b.js"><link rel="prefetch" href="/assets/js/78.794ec033.js"><link rel="prefetch" href="/assets/js/79.5559092c.js"><link rel="prefetch" href="/assets/js/8.999d1907.js"><link rel="prefetch" href="/assets/js/80.370cb4a3.js"><link rel="prefetch" href="/assets/js/81.84c0ef11.js"><link rel="prefetch" href="/assets/js/82.c1bd7cf9.js"><link rel="prefetch" href="/assets/js/83.b26fbfb4.js"><link rel="prefetch" href="/assets/js/84.282187d3.js"><link rel="prefetch" href="/assets/js/85.a1f13841.js"><link rel="prefetch" href="/assets/js/86.17770f27.js"><link rel="prefetch" href="/assets/js/87.ca3a6800.js"><link rel="prefetch" href="/assets/js/88.ec49fb73.js"><link rel="prefetch" href="/assets/js/89.db05fb75.js"><link rel="prefetch" href="/assets/js/9.298dcb77.js"><link rel="prefetch" href="/assets/js/90.72b46b81.js"><link rel="prefetch" href="/assets/js/91.423e822c.js"><link rel="prefetch" href="/assets/js/92.dfdfe5b8.js"><link rel="prefetch" href="/assets/js/93.4715b8c5.js"><link rel="prefetch" href="/assets/js/94.dd8abaff.js"><link rel="prefetch" href="/assets/js/95.1cfc11fd.js"><link rel="prefetch" href="/assets/js/96.7f19a7b2.js"><link rel="prefetch" href="/assets/js/97.0d16d0a6.js"><link rel="prefetch" href="/assets/js/98.b142e6de.js"><link rel="prefetch" href="/assets/js/99.d3f473b7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4744510a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">小烜同学</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">系列文章</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/series/webrtc/" class="nav-link">WebRTC 视频直播</a></li><li class="dropdown-item"><!----> <a href="/series/how_javascript_work/" class="nav-link">JavaScript 如何工作</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">面试题目</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/interview/javascript/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/interview/html/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/interview/css/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/interview/browser/" class="nav-link">浏览器</a></li><li class="dropdown-item"><!----> <a href="/interview/optimize/" class="nav-link">性能优化</a></li><li class="dropdown-item"><!----> <a href="/interview/react/" class="nav-link">React</a></li><li class="dropdown-item"><!----> <a href="/interview/correspond/" class="nav-link">通信相关</a></li><li class="dropdown-item"><!----> <a href="/interview/secure/" class="nav-link">安全相关</a></li></ul></div></div><div class="nav-item"><a href="/leetcode/" class="nav-link">LeetCode</a></div><div class="nav-item"><a href="/article/" class="nav-link router-link-active">随笔文章</a></div><div class="nav-item"><a href="/tips/" class="nav-link">Tips</a></div><div class="nav-item"><a href="/activity/" class="nav-link">活动总结</a></div><div class="nav-item"><a href="/read/" class="nav-link">文章阅读</a></div><div class="nav-item"><a href="/collection/" class="nav-link">资源收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">我的信息</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://juejin.im/user/59cbb8d46fb9a00a6c12c2cf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/balancelove" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">友情链接</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://omyleon.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  omyleon
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://www.godotdotdot.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  godotdotdot
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.yvesx.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  举头三尺有神鱼
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://knownsec-fed.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  创宇前端
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">系列文章</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/series/webrtc/" class="nav-link">WebRTC 视频直播</a></li><li class="dropdown-item"><!----> <a href="/series/how_javascript_work/" class="nav-link">JavaScript 如何工作</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">面试题目</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/interview/javascript/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/interview/html/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/interview/css/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/interview/browser/" class="nav-link">浏览器</a></li><li class="dropdown-item"><!----> <a href="/interview/optimize/" class="nav-link">性能优化</a></li><li class="dropdown-item"><!----> <a href="/interview/react/" class="nav-link">React</a></li><li class="dropdown-item"><!----> <a href="/interview/correspond/" class="nav-link">通信相关</a></li><li class="dropdown-item"><!----> <a href="/interview/secure/" class="nav-link">安全相关</a></li></ul></div></div><div class="nav-item"><a href="/leetcode/" class="nav-link">LeetCode</a></div><div class="nav-item"><a href="/article/" class="nav-link router-link-active">随笔文章</a></div><div class="nav-item"><a href="/tips/" class="nav-link">Tips</a></div><div class="nav-item"><a href="/activity/" class="nav-link">活动总结</a></div><div class="nav-item"><a href="/read/" class="nav-link">文章阅读</a></div><div class="nav-item"><a href="/collection/" class="nav-link">资源收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">我的信息</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://juejin.im/user/59cbb8d46fb9a00a6c12c2cf" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/balancelove" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">友情链接</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://omyleon.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  omyleon
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://www.godotdotdot.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  godotdotdot
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.yvesx.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  举头三尺有神鱼
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://knownsec-fed.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  创宇前端
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/article/event_loop.html" class="active sidebar-link">一道面试题引发的血案</a></li><li><a href="/article/ca.html" class="sidebar-link">数字证书那些事</a></li><li><a href="/article/fe_project.html" class="sidebar-link">前端工程化</a></li><li><a href="/article/module.html" class="sidebar-link">es6 模块化与 node 的模块化</a></li><li><a href="/article/sentry.html" class="sidebar-link">给你的项目装个探头 — Sentry</a></li><li><a href="/article/spa.html" class="sidebar-link">大话 SPA router</a></li><li><a href="/article/async_await_for.html" class="sidebar-link">async、await 在 for 循环里怎么样？</a></li><li><a href="/article/timing_attack.html" class="sidebar-link">Timing Attack</a></li><li><a href="/article/type_change.html" class="sidebar-link">JS 看不懂的 []+{}</a></li><li><a href="/article/webpack.html" class="sidebar-link">换个角度学 Webpack</a></li><li><a href="/article/grid.html" class="sidebar-link">Grid 布局发车啦</a></li><li><a href="/article/http_cache.html" class="sidebar-link">Http 缓存那些事</a></li><li><a href="/article/write_readme.html" class="sidebar-link">怎么写一个高逼格的 README</a></li><li><a href="/article/stream.html" class="sidebar-link">流“忙”</a></li><li><a href="/article/performance.html" class="sidebar-link">试炼之石 - Performance</a></li><li><a href="/article/2018to2019.html" class="sidebar-link">2018 年终总结</a></li><li><a href="/article/babel_plugin.html" class="sidebar-link">你会 babel 插件么？我也不会</a></li><li><a href="/article/base64.html" class="sidebar-link">Base64 编码</a></li><li><a href="/article/css_ellipsis.html" class="sidebar-link">CSS 实现单行文本、多行文本溢出省略号</a></li><li><a href="/article/dsa.html" class="sidebar-link">数据结构与算法</a></li><li><a href="/article/eslint_rule.html" class="sidebar-link">ESLint 校验规则集的思考</a></li><li><a href="/article/generator.html" class="sidebar-link">ES6 之 generator</a></li><li><a href="/article/react_hoc.html" class="sidebar-link">React 高阶组件</a></li><li><a href="/article/react_mixin_hooks.html" class="sidebar-link">React Mixin 到 Hooks</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="一道面试题引发的血案"><a href="#一道面试题引发的血案" aria-hidden="true" class="header-anchor">#</a> 一道面试题引发的血案</h1> <p>这次我们就不要那么多前戏，直奔主题，我们的龙门阵正式开始。</p> <p>开局一道题，内容全靠吹。（此处应有滑稽）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 文件名: index.js</span>
<span class="token comment">// 我们尽量模拟所有的异步场景，包括 timers、Promise、nextTick等等</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./index.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'I/O callback'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick 2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick 3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout 2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick 4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise run'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick 5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'promise then'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate 2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p><strong>note:</strong> 上面的代码执行环境是 node v10.7.0，浏览器的事件循环和 node 还是有一点区别的，有兴趣的可以自己找资料看一看。</p> <p>好了，上面的代码涉及到定时器、nextTick、Promise、setImmediate 和 I/O 操作。头皮有点小发麻哈，大家想好答案了么？检查一下吧！</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>promise run
nextTick <span class="token number">1</span>
nextTick <span class="token number">5</span>
promise then
timeout <span class="token number">1</span>
immediate <span class="token number">1</span>
immediate <span class="token number">2</span>
nextTick <span class="token number">3</span>
<span class="token constant">I</span><span class="token operator">/</span><span class="token constant">O</span> callback
nextTick <span class="token number">2</span>
timeout <span class="token number">2</span>
nextTick <span class="token number">4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>怎么样？跟自己想的一样么？不一样的话，就听我慢慢道来。</p> <h2 id="event-loop"><a href="#event-loop" aria-hidden="true" class="header-anchor">#</a> event loop</h2> <p>在 Node.js 中，event loop 是基于 libuv 的。通过查看 <a href="http://docs.libuv.org/en/v1.x/design.html" target="_blank" rel="noopener noreferrer">libuv<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的文档可以发现整个 event loop 分为 6 个阶段：</p> <ul><li>timers: 定时器相关任务，node 中我们关注的是它会执行 setTimeout() 和 setInterval() 中到期的回调</li> <li>pending callbacks: 执行某些系统操作的回调</li> <li>idle, prepare: 内部使用</li> <li>poll: 执行 I/O callback，一定条件下会在这个阶段阻塞住</li> <li>check: 执行 setImmediate 的回调</li> <li>close callbacks: 如果 socket 或者 handle 关闭了，就会在这个阶段触发 close 事件，执行 close 事件的回调</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>   ┌───────────────────────────┐
┌─&gt;│           timers          │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │     pending callbacks     │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │       idle, prepare       │
│  └─────────────┬─────────────┘      ┌───────────────┐
│  ┌─────────────┴─────────────┐      │   incoming:   │
│  │           poll            │&lt;─────┤  connections, │
│  └─────────────┬─────────────┘      │   data, etc.  │
│  ┌─────────────┴─────────────┐      └───────────────┘
│  │           check           │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
└──┤      close callbacks      │
   └───────────────────────────┘
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>event loop 的代码在文件 <code>deps/uv/src/unix/core.c</code> 中。</p> <div class="language-c++ line-numbers-mode"><pre class="language-text"><code>int uv_run(uv_loop_t* loop, uv_run_mode mode) {
  int timeout;
  int r;
  int ran_pending;

  // 确定 event loop 是否继续
  r = uv__loop_alive(loop);
  if (!r)
    uv__update_time(loop);

  while (r != 0 &amp;&amp; loop-&gt;stop_flag == 0) {
    uv__update_time(loop); // 更新时间
    uv__run_timers(loop); // timers 阶段
    ran_pending = uv__run_pending(loop); // pending callbacks 阶段
    uv__run_idle(loop); // idle 阶段
    uv__run_prepare(loop); // prepare 阶段

    timeout = 0;
    // 设置 poll 阶段的超时时间，有以下情况超时时间设为 0，此时 poll 不会阻塞
    // 1. stop_flag 不为 0
    // 2. 没有活跃的 handles 和 request
    // 3. idle、pending callback、close 阶段 handle 队列不为空
    // 否则的话会将超时时间设置成距离当前时间最近的 timer 的时间
    if ((mode == UV_RUN_ONCE &amp;&amp; !ran_pending) || mode == UV_RUN_DEFAULT)
      timeout = uv_backend_timeout(loop);

    // poll 阶段
    uv__io_poll(loop, timeout);
    // check 阶段
    uv__run_check(loop);
    // close 阶段
    uv__run_closing_handles(loop);

    if (mode == UV_RUN_ONCE) {
      uv__update_time(loop);
      uv__run_timers(loop);
    }

    r = uv__loop_alive(loop);
    if (mode == UV_RUN_ONCE || mode == UV_RUN_NOWAIT)
      break;
  }

  if (loop-&gt;stop_flag != 0)
    loop-&gt;stop_flag = 0;

  return r;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h2 id="注册加触发"><a href="#注册加触发" aria-hidden="true" class="header-anchor">#</a> 注册加触发</h2> <p>这一小节我们主要看看 Node 如何将我们写的定时器等等注册到 event loop 中去并执行的。</p> <p>以 setTimeout 为例，首先我们进到了 <code>timers.js</code> 这个文件中，找到了 <code>setTimeout</code> 函数，我们主要关注这么两句：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> after<span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">,</span> arg3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">const</span> timeout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Timeout</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> after<span class="token punctuation">,</span> args<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">active</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> timeout<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>我们看到它 new 了一个 Timeout 类，我们顺着这条线索找到了 Timeout 的构造函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Timeout</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> after<span class="token punctuation">,</span> args<span class="token punctuation">,</span> isRepeat</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_onTimeout <span class="token operator">=</span> callback<span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>我们主要关注这一句，Node 将回调挂载到了 <code>_onTimeout</code> 这个属性上。那么这个回调是在什么时候执行的呢？我们全局搜一下 <code>_onTimeout()</code>，我们可以发现是一个叫做 <code>ontimeout</code> 的方法执行了回调，好了，我们开始顺藤摸瓜，可以找到这么一条调用路径 <code>processTimers -&gt; listOnTimeout -&gt; tryOnTimeout -&gt; ontimeout -&gt; _onTimeout</code>。</p> <p>最后的最后，我们在文件的头部发现了这么几行代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>
  getLibuvNow<span class="token punctuation">,</span>
  setupTimers<span class="token punctuation">,</span>
  scheduleTimer<span class="token punctuation">,</span>
  toggleTimerRef<span class="token punctuation">,</span>
  immediateInfo<span class="token punctuation">,</span>
  toggleImmediateRef
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">internalBinding</span><span class="token punctuation">(</span><span class="token string">'timers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setupTimers</span><span class="token punctuation">(</span>processImmediate<span class="token punctuation">,</span> processTimers<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>我们一看，<code>setupTimers</code> 是从 <code>internalBinding('timers')</code> 获取的，我们去看一下 <code>internalBinding</code> 就知道这就是 js 代码和内建模块关联的地方了。于是，我们顺着这条线索往下找，我们去 <code>src</code> 目录下去找叫 timers 的文件，果不其然，我们找到一个叫 <code>timers.cc</code> 的文件，同时，找到了一个叫 <code>SetupTimers</code> 的函数。</p> <div class="language-c++ line-numbers-mode"><pre class="language-text"><code>void SetupTimers(const FunctionCallbackInfo&lt;Value&gt;&amp; args) {
  CHECK(args[0]-&gt;IsFunction());
  CHECK(args[1]-&gt;IsFunction());
  auto env = Environment::GetCurrent(args);

  env-&gt;set_immediate_callback_function(args[0].As&lt;Function&gt;());
  env-&gt;set_timers_callback_function(args[1].As&lt;Function&gt;());
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>上面的 <code>args[1]</code> 就是我们传递的 <code>processTimers</code>，在这个函数中我们其实就完成了 <code>processTimers</code> 的注册，它成功的注册到了 node 中。</p> <p>那是如何触发的回调呢？这里我们首先先看到 event loop 代码中的 timers 阶段执行的函数，然后跟进去：</p> <div class="language-c++ line-numbers-mode"><pre class="language-text"><code>void uv__run_timers(uv_loop_t* loop) {
  struct heap_node* heap_node;
  uv_timer_t* handle;

  for (;;) {
    heap_node = heap_min(timer_heap(loop));
    if (heap_node == NULL)
      break;

    handle = container_of(heap_node, uv_timer_t, heap_node);
    if (handle-&gt;timeout &gt; loop-&gt;time)
      break;

    uv_timer_stop(handle);
    uv_timer_again(handle);
    handle-&gt;timer_cb(handle);
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这段代码我们将我们的目光放在 <code>handle-&gt;timer_cb(handle)</code> 这一行，这个函数是在哪儿定义的呢？我们全局搜一下 <code>timer_cb</code> 发现 <code>uv_timer_start</code> 中有这么一行代码：</p> <div class="language-c++ line-numbers-mode"><pre class="language-text"><code>handle-&gt;timer_cb = cb;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所以我们知道是调用了 <code>uv_timer_start</code> 将回调函数挂载到了 handle 上。那么 cb 又是什么呢？其实你沿着代码上去找就能发现其实 cb 就是 <code>timers_callback_function</code>，眼熟对么？这就是我们上面注册进来触发回调的函数 <code>processTimers</code>。</p> <p>恍然大悟，原来是这么触发的回调，现在还有个问题，谁去调用的 <code>uv_timer_start</code> 呢？这个问题就简单了，我们通过源码可以知道是 <code>ScheduleTimer</code> 这个函数调用了，是不是感觉很熟悉，对，这个函数就是我们通过 <code>internalBinding</code> 引进来的 <code>scheduleTimer</code> 函数。</p> <p>在这个地方就有点不一样了。现在最新的 tag 版本和 github 上 node 最新的代码是有区别的，在一次 pr 中，将 <code>timer_wrap.cc</code> 重构成了 <code>timers.cc</code>，并且移除了 <code>TimerWrap</code> 类，再说下面的区别之前，先补充一下 <code>timer</code> 对应的数据结构：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 这是在有 TimeWrap 的版本</span>
<span class="token comment">// 对应的时间后面是一个 timer 链表</span>
refedLists <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token number">1000</span><span class="token punctuation">:</span> TimeWrap<span class="token punctuation">.</span><span class="token function">_list</span><span class="token punctuation">(</span><span class="token function">TimersList</span><span class="token punctuation">(</span>item<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">&gt;</span>item<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">&gt;</span>item<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">&gt;</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token number">2000</span><span class="token punctuation">:</span> TimeWrap<span class="token punctuation">.</span><span class="token function">_list</span><span class="token punctuation">(</span><span class="token function">TimersList</span><span class="token punctuation">(</span>item<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">&gt;</span>item<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">&gt;</span>item<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">&gt;</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 这是 scheduleTimer 的版本</span>
refedLists <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token number">1000</span><span class="token punctuation">:</span> <span class="token function">TimersList</span><span class="token punctuation">(</span>item<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">&gt;</span>item<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">&gt;</span>item<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">&gt;</span>item<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token number">2000</span><span class="token punctuation">:</span> <span class="token function">TimersList</span><span class="token punctuation">(</span>item<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">&gt;</span>item<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">&gt;</span>item<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">&gt;</span>item<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在 <code>TimeWrap</code> 的版本里，js 是通过调用实例化后的 <code>start()</code> 函数去调用了 <code>uv_timer_start</code>。</p> <p>而 <code>scheduleTimer</code> 版本是注册定时器的时候通过比较哪个定时器是最近要执行的，从而将对应时间的 <code>timerList</code> 注册到 <code>uv_timer</code> 中去。</p> <p>那么，为什么要这么改呢？是为了让定时器和 Immediate 拥有更相似的行为，也就是将单个 uv_timer_t handle 存在 Environment 上（Immediate 是有一个 ImmediateQueue，这也是个链表）。</p> <p>这里就只说了一个 timer，其他的大家就自己去看看吧，顺着这个思路大家肯定会有所收获的。</p> <h2 id="事件循环流程"><a href="#事件循环流程" aria-hidden="true" class="header-anchor">#</a> 事件循环流程</h2> <p>在加载 node 的时候，将 setTimeout、setInterval 的回调注册到 timerList，将 Promise.resolve 等 microTask 的回调注册到 microTasks，将 setImmediate 注册到 immediateQueue 中，将 process.nextTick 注册到 nextTickQueue 中。</p> <p>当我们开始 event loop 的时候，首先进入 timers 阶段（我们只看跟我们上面说的相关的阶段），然后就判断 timerList 的时间是否到期了，如果到期了就执行，没有就下一个阶段（其实还有 nextTick，等下再说）。</p> <p>接下来我们说 poll 阶段，在这个阶段，我们先计算需要在这个阶段阻塞轮询的时间（简单点就是下个 timer 的时间），然后等待监听的事件。</p> <p>下个阶段是 check 阶段，对应的是 immediate，当有 immediateQueue 的时候就会跳过 poll 直接到 check 阶段执行 setImmediate 的回调。</p> <p>那有同学就要问了，nextTick 和 microTasks 去哪儿了啊？别慌，听我慢慢道来。</p> <h2 id="process-nexttick-和-microtasks"><a href="#process-nexttick-和-microtasks" aria-hidden="true" class="header-anchor">#</a> process.nextTick 和 microTasks</h2> <p>现在我们有了刚刚找 timer 的经验，我们继续去看看 nextTick 是怎么执行的。</p> <p>经过排查我们能找到一个叫 <code>_tickCallback</code> 的函数，它不断的从 nextTickQueue 中获取 nextTick 的回调执行。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_tickCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> tock<span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tock <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token keyword">const</span> callback <span class="token operator">=</span> tock<span class="token punctuation">.</span>callback<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tock<span class="token punctuation">.</span>args <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> <span class="token function">Reflect</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> tock<span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">emitAfter</span><span class="token punctuation">(</span>asyncId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    tickInfo<span class="token punctuation">[</span>kHasScheduled<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">runMicrotasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>queue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">emitPromiseRejectionWarnings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tickInfo<span class="token punctuation">[</span>kHasPromiseRejections<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>我们看到了什么？在将 nextTick 的回调执行完之后，它执行了 <code>runMicrotasks</code>。一切都真相大白了，microTasks 的执行时机是当执行完所有的 nextTick 的回调之后。那 nextTick 又是在什么时候执行的呢？</p> <p>这就需要我们去找 C++ 的代码了，在 <code>bootstrapper.cc</code> 里找到了 <code>BOOTSTRAP_METHOD(_setupNextTick, SetupNextTick)</code>，所以我们就要去找 <code>SetupNextTick</code> 函数。</p> <div class="language-c++ line-numbers-mode"><pre class="language-text"><code>void SetupNextTick(const FunctionCallbackInfo&lt;Value&gt;&amp; args) {
  Environment* env = Environment::GetCurrent(args);
  // ...
  env-&gt;set_tick_callback_function(args[0].As&lt;Function&gt;());
  // ...
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>我们关注这一句，是不是很熟啊，跟上面 timer 一样是吧，我们将 <code>__tickCallback</code> 注册到了 node，在 C++ 中通过 <code>tick_callback_function</code> 来调用这个函数。</p> <p>我们通过查看源码可以发现是 <code>InternalCallbackScope</code> 这个类调用 <code>Close</code> 函数的时候就会触发 nextTixk 执行。</p> <div class="language-c++ line-numbers-mode"><pre class="language-text"><code>void InternalCallbackScope::Close() {
  if (closed_) return;
  closed_ = true;
  HandleScope handle_scope(env_-&gt;isolate());
  // ...
  if (!tick_info-&gt;has_scheduled()) {
    env_-&gt;isolate()-&gt;RunMicrotasks();
  }
  // ...
  if (!tick_info-&gt;has_scheduled() &amp;&amp; !tick_info-&gt;has_promise_rejections()) {
    return;
  }
  // ...
  if (env_-&gt;tick_callback_function()-&gt;Call(process, 0, nullptr).IsEmpty()) {
    failed_ = true;
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>可能有同学有疑问了，为啥在执行 nextTick 上面还有 <code>RunMicrotasks</code> 呢？其实这是对 event loop 的优化，假如没有 <code>process.nextTick</code> 就直接从 node 里面调用 <code>RunMicrotasks</code> 加快速度。</p> <p>现在在 <code>node.cc</code> 里我们找到了调用 <code>Close</code> 的地方：</p> <div class="language-c++ line-numbers-mode"><pre class="language-text"><code>MaybeLocal&lt;Value&gt; InternalMakeCallback(Environment* env,
                                       Local&lt;Object&gt; recv,
                                       const Local&lt;Function&gt; callback,
                                       int argc,
                                       Local&lt;Value&gt; argv[],
                                       async_context asyncContext) {
  CHECK(!recv.IsEmpty());
  InternalCallbackScope scope(env, recv, asyncContext);

  scope.Close();

  return ret;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>而 <code>InternalMakeCallback()</code> 则是在 <code>async_wrap.cc</code> 的 <code>AsyncWrap::MakeCallback()</code> 中被调用。</p> <p>找了半天，只找到了 setImmediate 注册时，注册函数执行回调运行了这个函数，没有找到 timer 的。之前因为使用的 TimeWrap，TimeWrap 继承了 AsyncWrap，在执行回调的时候调用了 <code>MakeCallback()</code>，问题是现在移除了 <code>TimeWrap</code>，那是怎么调用的呢？我们会到 js 代码，发现了这样的代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> _tickCallback<span class="token punctuation">:</span> runNextTicks <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">processTimers</span><span class="token punctuation">(</span><span class="token parameter">now</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">runNextTicks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>一切都明了了，在移除了 <code>TimeWrap</code> 之后，将 <code>_tickCallback</code> 放到了这里执行，所以我们刚刚在 C++ 里找不到。</p> <p>其实，每一个阶段执行完之后，都会去执行 <code>_tickCallback</code> ，只是方式可能有点不同。</p> <h2 id="答案解析"><a href="#答案解析" aria-hidden="true" class="header-anchor">#</a> 答案解析</h2> <p>好了，刚刚了解了关于 event loop 的一些情况，我们再来看看文章开头的那段代码，我们一起来分析。</p> <h3 id="第一步"><a href="#第一步" aria-hidden="true" class="header-anchor">#</a> 第一步</h3> <p>首先运行 Promise 里的代码，<strong>输出了 promise run</strong>，然后 promise.resolve 将 then 放入 microTasks。</p> <h3 id="第二步"><a href="#第二步" aria-hidden="true" class="header-anchor">#</a> 第二步</h3> <p>这里要提到的一点是 nextTick 在注册之后，bootstrap 构建结束后运行<code>SetupNextTick</code>函数，这时候就会清空 nextTickQueue 和 MicroTasks，所以<strong>输出 nextTick 1、nextTick 5、promise then</strong>。</p> <h3 id="第三步"><a href="#第三步" aria-hidden="true" class="header-anchor">#</a> 第三步</h3> <p>在 bootstrap 之后便进入了 event loop，第一个阶段 timers，这时 timeout 1 定时器时间到期，执行回调<strong>输出 timeout 1</strong>，timerList 没有其他定时器了，去清空 nextTickQueue 和 MicroTasks，没有任务，这时继续下阶段，这时候有 immediate，所以跳过 poll，进入 check，执行 immediate 回调，<strong>输出 immediate 1 和 immediate 2</strong>，并将 nextTick 3 推入 nextTickQueue，阶段完成 immediateQueue 没有需要处理的东西了，就去清空 nextTickQueue 和 MicroTasks <strong>输出 nextTick 3</strong>。</p> <h3 id="第四步"><a href="#第四步" aria-hidden="true" class="header-anchor">#</a> 第四步</h3> <p>在这一轮，文件读取完成，并且 timers 没到期，进入 poll 阶段，超时时间设置为 timeout 2 的时间，执行回调<strong>输出 I/O callback</strong>，并且向 nextTickQueue 推入 nextTick 2。阻塞过程中没有其他的 I/O 事件，去清空 nextTickQueue 和 MicroTasks，<strong>输出 nextTick 2</strong>。</p> <h3 id="第五步"><a href="#第五步" aria-hidden="true" class="header-anchor">#</a> 第五步</h3> <p>这时候又到了 timers 阶段，执行 timeout 2 的回调，<strong>输出 timeout 2</strong>，将 nextTick 4 推入 nextTickQueue，这时 timeList 已经没有定时器了，清空 nextTickQueue 和 MicroTasks <strong>输出 nextTick 4</strong>。</p> <h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>不知道大家懂了没有，整个过程其实还比较粗糙，在学习过程中也看了不少的源码分析，但是 node 发展很快，很多分析已经过时了，源码改变了不少，但是对于理清思路还是很有作用的。</p> <p>各位看官如果觉得还行、OK、有点用，欢迎来我 <a href="https://github.com/balancelove/readingNotes" target="_blank" rel="noopener noreferrer">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 给个小星星，我会很舒服的，哈哈。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">8/19/2019, 6:45:46 PM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/article/ca.html">
          数字证书那些事
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.957eca14.js" defer></script><script src="/assets/js/2.ca8fc919.js" defer></script><script src="/assets/js/17.bccf36a0.js" defer></script>
  </body>
</html>
